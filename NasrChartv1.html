<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ù†Ù…ÙˆØ¯Ø§Ø± Ù‚ÛŒÙ…Øª Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ†</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #004080;
      color: #fff;
      transition: background-color 0.3s, color 0.3s;
    }
    #chart {
      width: 90%;
      max-width: 700px;
      height: 400px;
      margin: 20px auto;
      border-radius: 10px;
      background-color: white;
    }
    select, button {
      font-size: 16px;
      margin: 10px;
      padding: 6px 12px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Ù†Ù…ÙˆØ¯Ø§Ø± Ù‚ÛŒÙ…Øª Ø¨ÛŒØªâ€ŒÚ©ÙˆÛŒÙ† (USD)</h2>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <select id="timeFrame">
    <option value="live">Ø²Ù†Ø¯Ù‡</option>
    <option value="1W">1H</option>
    <option value="1M">4H</option>
    <option value="3M" selected>1D</option>
    <option value="6M">1W</option>
    <option value="1Y">1M</option>
  </select>

  <button id="toggleHorizontalLineBtn">ğŸ“ Ø§Ø¨Ø²Ø§Ø± Ø®Ø· Ø§ÙÙ‚ÛŒ</button>
  <button id="drawPathBtn">âœï¸ Ø§Ø¨Ø²Ø§Ø± Ù…Ø³ÛŒØ±</button>
  <button id="clearAllBtn">ğŸ—‘ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø®Ø·ÙˆØ· Ùˆ Ù…Ø³ÛŒØ±Ù‡Ø§</button>
  <button id="screenshotBtn">ğŸ“¸ Ú¯Ø±ÙØªÙ† Ø§Ø³Ú©Ø±ÛŒÙ†â€ŒØ´Ø§Øª</button>

  <div id="chart"></div>
  <div id="currentPrice">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>

  <script src="https://unpkg.com/lightweight-charts@4.0.0/dist/lightweight-charts.standalone.production.js"></script>

  <script>
    const chartContainer = document.getElementById('chart');
    const chart = LightweightCharts.createChart(chartContainer, {
      width: chartContainer.clientWidth,
      height: 400,
      layout: { backgroundColor: '#ffffff', textColor: '#000' },
      timeScale: { timeVisible: true }
    });

    const candleSeries = chart.addCandlestickSeries();
    let priceLines = [];
    let pathSeries = null;
    let pathPoints = [];
    let isHorizontalLineActive = false;
    let isPathDrawing = false;

    document.getElementById("toggleHorizontalLineBtn").addEventListener("click", () => {
      isHorizontalLineActive = !isHorizontalLineActive;
      alert(isHorizontalLineActive ? "Ø§Ø¨Ø²Ø§Ø± Ø®Ø· Ø§ÙÙ‚ÛŒ ÙØ¹Ø§Ù„ Ø´Ø¯!" : "Ø§Ø¨Ø²Ø§Ø± Ø®Ø· Ø§ÙÙ‚ÛŒ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯.");
    });

    document.getElementById("drawPathBtn").addEventListener("click", () => {
      isPathDrawing = !isPathDrawing;

      if (isPathDrawing) {
        pathPoints = [];
        if (pathSeries) {
          chart.removeSeries(pathSeries);
          pathSeries = null;
        }
        pathSeries = chart.addLineSeries({
          color: 'orange',
          lineWidth: 2,
          lineStyle: LightweightCharts.LineStyle.Solid,
        });
        alert("Ø­Ø§Ù„Øª Ù…Ø³ÛŒØ± ÙØ¹Ø§Ù„ Ø´Ø¯!");
      } else {
        alert("Ø­Ø§Ù„Øª Ù…Ø³ÛŒØ± ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯.");
      }
    });

    document.getElementById("clearAllBtn").addEventListener("click", () => {
      priceLines.forEach(line => candleSeries.removePriceLine(line));
      priceLines = [];

      if (pathSeries) {
        chart.removeSeries(pathSeries);
        pathSeries = null;
        pathPoints = [];
        isPathDrawing = false;
      }

      alert("Ù‡Ù…Ù‡ Ø®Ø·ÙˆØ· Ùˆ Ù…Ø³ÛŒØ±Ù‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯!");
    });

    document.getElementById("screenshotBtn").addEventListener("click", () => {
        html2canvas(document.getElementById("chart")).then(canvas => {
            const imageURL = canvas.toDataURL("image/png");
            const link = document.createElement("a");
            link.href = imageURL;
            link.download = "chart_screenshot.png";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    });

    chart.subscribeClick(param => {
      if (!param || !param.point) return;

      const price = candleSeries.coordinateToPrice(param.point.y);

      if (isHorizontalLineActive && price !== undefined) {
        const clickedIndex = priceLines.findIndex(line => {
          const y = candleSeries.priceToCoordinate(line.options().price);
          return Math.abs(y - param.point.y) < 5;
        });

        if (clickedIndex >= 0) {
          candleSeries.removePriceLine(priceLines[clickedIndex]);
          priceLines.splice(clickedIndex, 1);
        } else {
          const newLine = candleSeries.createPriceLine({
            price: price,
            color: 'red',
            lineWidth: 2,
            lineStyle: LightweightCharts.LineStyle.Solid,
            axisLabelVisible: true,
            title: 'Ø®Ø· Ø§ÙÙ‚ÛŒ',
          });
          priceLines.push(newLine);
        }
      }

      if (isPathDrawing) {
        const time = param.time;
        if (time !== undefined && price !== undefined) {
          pathPoints.push({ time, value: price });
          if (pathSeries) {
            pathSeries.setData(pathPoints);
          }
        }
      }
    });

    async function fetchCandles(days) {
      try {
        const res = await fetch(`https://api.coingecko.com/api/v3/coins/bitcoin/ohlc?vs_currency=usd&days=${days}`);
        const data = await res.json();
        return data.map(c => ({ time: Math.floor(c[0] / 1000), open: c[1], high: c[2], low: c[3], close: c[4] }));
      } catch (error) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§", error);
        return [];
      }
    }

    async function updateChart(days) {
      const data = await fetchCandles(days);
      if (data.length > 0) {
        candleSeries.setData(data);
        document.getElementById("currentPrice").textContent = `Ø¢Ø®Ø±ÛŒÙ† Ù‚ÛŒÙ…Øª: $${data[data.length - 1].close.toFixed(2)}`;
        chart.timeScale().fitContent();
      } else {
        document.getElementById("currentPrice").textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§";
      }
    }

    document.getElementById("timeFrame").addEventListener("change", () => {
      const tf = document.getElementById("timeFrame").value;
      if (tf === "live") updateChart(1);
      else if (tf === "1W") updateChart(7);
      else if (tf === "1M") updateChart(30);
      else if (tf === "3M") updateChart(90);
      else if (tf === "6M") updateChart(180);
      else if (tf === "1Y") updateChart(365);
    });

    document.addEventListener("DOMContentLoaded", () => {
      updateChart(90);
    });
  </script>
</body>
</html>